// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Note: SQLite doesn't support enums, so we use String with default values
// Valid values are enforced in application code

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  passwordHash      String?
  role              String             @default("USER")
  status            String             @default("ACTIVE")
  emailVerified     Boolean            @default(false)
  locale            String             @default("ja")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  profile           Profile?
  verification      Verification?
  preferences       Preference?
  groupMemberships  GroupMember[]
  rsvps             RSVP[]
  messages          Message[]
  feedbacks         Feedback[]
  reports           Report[]           @relation("ReporterReports")
  reportsAgainst    Report[]           @relation("ReportedUserReports")
  magicLinks        MagicLink[]

  @@index([email])
  @@index([status])
}

model Profile {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  nickname        String
  realName        String?
  birthYear       Int
  photoUrl        String?
  bio             String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

model Verification {
  id                String              @id @default(cuid())
  userId            String              @unique
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  status            String              @default("UNVERIFIED")
  idImagePath       String?
  selfieImagePath   String?

  submittedAt       DateTime?
  reviewedAt        DateTime?
  reviewedBy        String?
  rejectionReason   String?

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([userId])
  @@index([status])
}

model Preference {
  id                        String    @id @default(cuid())
  userId                    String    @unique
  user                      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Matching preferences
  ageBandMin                Int       @default(20)
  ageBandMax                Int       @default(40)
  preferredAreas            String    // JSON array of area codes
  availableTimes            String    // JSON array of time slots

  // Interests & lifestyle
  interests                 String    // JSON array of interest tags
  drinkingOk                Boolean   @default(true)
  smokingOk                 Boolean   @default(false)
  conversationDepth         String    @default("BALANCED") // LIGHT, BALANCED, DEEP
  quietMode                 Boolean   @default(false)

  // Boundaries
  noAlcoholMeetups          Boolean   @default(false)
  preferAfternoons          Boolean   @default(false)
  preferWeekends            Boolean   @default(false)

  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  @@index([userId])
}

model Group {
  id                String        @id @default(cuid())
  cohortName        String
  status            String        @default("FORMING")
  weekNumber        Int           @default(1)
  maxWeeks          Int           @default(6)

  targetArea        String?
  targetTimeSlot    String?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  completedAt       DateTime?

  members           GroupMember[]
  events            Event[]
  chatThreads       ChatThread[]

  @@index([status])
  @@index([cohortName])
}

model GroupMember {
  id                String    @id @default(cuid())
  groupId           String
  group             Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  joinedAt          DateTime  @default(now())
  leftAt            DateTime?
  isActive          Boolean   @default(true)

  compatibilityScore Float?

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

model Event {
  id                String        @id @default(cuid())
  groupId           String
  group             Group         @relation(fields: [groupId], references: [id], onDelete: Cascade)

  weekNumber        Int
  status            String        @default("SCHEDULED")

  scheduledAt       DateTime
  location          String
  locationDetails   String?
  address           String?

  title             String
  description       String?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  confirmedAt       DateTime?
  completedAt       DateTime?

  rsvps             RSVP[]
  feedbacks         Feedback[]
  promptAssignments EventPromptAssignment[]

  @@index([groupId])
  @@index([status])
  @@index([scheduledAt])
}

model RSVP {
  id                String      @id @default(cuid())
  eventId           String
  event             Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  status            String      @default("PENDING")

  checkedIn         Boolean     @default(false)
  checkedInAt       DateTime?
  checkedOut        Boolean     @default(false)
  checkedOutAt      DateTime?

  acceptedGuidelinesAt DateTime?

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
}

model ChatThread {
  id                String    @id @default(cuid())
  groupId           String
  group             Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  name              String
  isArchived        Boolean   @default(false)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  messages          Message[]

  @@index([groupId])
  @@index([isArchived])
}

model Message {
  id                String      @id @default(cuid())
  threadId          String
  thread            ChatThread  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  content           String
  isSystemMessage   Boolean     @default(false)

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  deletedAt         DateTime?

  @@index([threadId])
  @@index([userId])
  @@index([createdAt])
}

model PromptCard {
  id                String    @id @default(cuid())

  titleJa           String
  titleEn           String
  promptJa          String
  promptEn          String

  weekNumber        Int?
  category          String    @default("ICEBREAKER")
  isActive          Boolean   @default(true)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  eventAssignments  EventPromptAssignment[]

  @@index([weekNumber])
  @@index([category])
  @@index([isActive])
}

model EventPromptAssignment {
  id                String      @id @default(cuid())
  eventId           String
  event             Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  promptId          String
  prompt            PromptCard  @relation(fields: [promptId], references: [id], onDelete: Cascade)

  order             Int         @default(0)

  createdAt         DateTime    @default(now())

  @@unique([eventId, promptId])
  @@index([eventId])
  @@index([promptId])
}

model Feedback {
  id                String    @id @default(cuid())
  eventId           String
  event             Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  vibeRating        Int       // 1-5
  safetyRating      Int       // 1-5
  wantToContinue    Boolean   @default(false)

  whatWorked        String?
  whatDidntWork     String?
  suggestions       String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model Report {
  id                String          @id @default(cuid())
  reporterId        String
  reporter          User            @relation("ReporterReports", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUserId    String?
  reportedUser      User?           @relation("ReportedUserReports", fields: [reportedUserId], references: [id], onDelete: Cascade)

  category          String
  status            String          @default("PENDING")

  details           String
  context           String?         // JSON: threadId, eventId, messageId, etc.

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  resolvedAt        DateTime?
  resolvedBy        String?
  resolution        String?

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([status])
  @@index([category])
}

model AdminAuditLog {
  id                String    @id @default(cuid())
  adminId           String

  action            String
  targetType        String?   // User, Group, Event, Report, etc.
  targetId          String?

  details           String?   // JSON
  ipAddress         String?

  createdAt         DateTime  @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

model MagicLink {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  token             String    @unique
  expiresAt         DateTime
  used              Boolean   @default(false)

  createdAt         DateTime  @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model Waitlist {
  id                String    @id @default(cuid())
  userId            String

  preferredAreas    String    // JSON array
  preferredTimes    String    // JSON array

  addedAt           DateTime  @default(now())
  notifiedAt        DateTime?

  @@index([userId])
  @@index([addedAt])
}
